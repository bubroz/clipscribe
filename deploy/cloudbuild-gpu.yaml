# Cloud Build Config for Station10.media GPU Worker
# Deploys WhisperX to Cloud Run with NVIDIA T4 GPU

steps:
  # Build GPU Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-gpu-worker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/station10-gpu-worker:${_VERSION}'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/station10-gpu-worker:latest'
      - '-f'
      - 'Dockerfile.gpu'
      - '.'
    timeout: 1200s  # 20 minutes for GPU image build

  # Push image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-gpu-worker'
    waitFor: ['build-gpu-worker']
    args:
      - 'push'
      - 'gcr.io/${PROJECT_ID}/station10-gpu-worker:${_VERSION}'

  # Deploy as Cloud Run Job with GPU
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-gpu-job'
    waitFor: ['push-gpu-worker']
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'jobs'
      - 'create'
      - 'station10-gpu-worker'
      - '--image=gcr.io/${PROJECT_ID}/station10-gpu-worker:${_VERSION}'
      - '--region=${_REGION}'
      - '--gpu=1'
      - '--gpu-type=nvidia-l4'
      - '--memory=16Gi'
      - '--cpu=4'
      - '--task-timeout=30m'
      - '--max-retries=1'
      - '--set-env-vars=GCP_PROJECT=${PROJECT_ID},GCS_BUCKET=${_GCS_BUCKET}'
      - '--set-secrets=HUGGINGFACE_TOKEN=HUGGINGFACE_TOKEN:latest'

  # Update job if already exists
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'update-gpu-job'
    waitFor: ['deploy-gpu-job']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud run jobs update station10-gpu-worker \
          --image=gcr.io/${PROJECT_ID}/station10-gpu-worker:${_VERSION} \
          --region=${_REGION} \
          || echo "Job doesn't exist yet, skipping update"

# Substitutions
substitutions:
  _VERSION: 'v1.0.0-gpu'
  _REGION: 'us-central1'
  _GCS_BUCKET: 'prismatic-iris-429006-g6-clipscribe'

# Build config
timeout: 1800s  # 30 minutes total
options:
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 100
  logging: CLOUD_LOGGING_ONLY

# Store image
images:
  - 'gcr.io/${PROJECT_ID}/station10-gpu-worker:${_VERSION}'
  - 'gcr.io/${PROJECT_ID}/station10-gpu-worker:latest'

