---
description: Patterns and conventions for CLI commands using Click
globs: 
alwaysApply: false
---
---
description: "Patterns and conventions for CLI commands using Click"
globs: ["src/clipscribe/commands/**/*.py", "**/cli.py"]
alwaysApply: false
---

# CLI Command Patterns

## Command Structure

ClipScribe uses Click for CLI with async support. Follow these patterns:

### Basic Command Template
```python
@cli.command()
@click.argument("url")
@click.option("--output-dir", "-o", type=click.Path(), default=Path("output"))
@click.option("--format", "-f", type=click.Choice(['txt', 'srt', 'vtt', 'json']))
@click.pass_context
async def command_name(ctx: click.Context, url: str, output_dir: Path, format: str):
    """Command description for --help.
    
    Examples:
        clipscribe command-name "https://..."
    """
    settings = ctx.obj["settings"]
    # Implementation
```

### Async Command Execution
The CLI properly handles async commands:
```python
def run_cli():
    if len(sys.argv) > 1 and sys.argv[1] in ["transcribe", "research"]:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            def sync_wrapper():
                future = asyncio.ensure_future(cli.main(standalone_mode=False))
                loop.run_until_complete(future)
            sync_wrapper()
        finally:
            loop.close()
    else:
        cli()
```

## Output Patterns

### Progress Display
Use Rich for beautiful output:
```python
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.table import Table

console = Console()

with console.status("[bold green]Processing...") as status:
    status.update("[bold green]Downloading video...")
    # Work here
    
# Display results in a table
table = Table(title="Results")
table.add_column("Property", style="cyan")
table.add_column("Value", style="green")
table.add_row("Title", video.metadata.title)
console.print(table)
```

### Error Handling
```python
try:
    result = await processor.process(url)
except KeyboardInterrupt:
    console.print("\n[yellow]Operation cancelled by user[/yellow]")
    sys.exit(1)
except Exception as e:
    logger.exception("Operation failed")
    console.print(f"[red]Error: {str(e)}[/red]")
    sys.exit(1)
```

## Option Conventions

### Common Options
- `--output-dir, -o`: Output directory (Path type)
- `--format, -f`: Output format (Choice type)
- `--debug`: Enable debug logging (flag)
- `--no-cache`: Disable caching (flag with inverse)
- `--max-results, -n`: Limit results (int with default)

### Help Text Format
```python
@click.option(
    '--mode', '-m',
    type=click.Choice(['audio', 'video', 'auto']),
    default='audio',
    help="""Processing mode:
    
    • audio (default): Extract audio only - Fast & cheap ($0.002/min)
      Best for: Podcasts, interviews, meetings
      
    • video: Process full video - Slower & expensive (~$0.02/min)
      Best for: Tutorials, presentations
    """
)
```

## Settings Integration

Always load settings from context:
```python
@click.pass_context
def command(ctx: click.Context):
    settings = ctx.obj["settings"]  # Type: Settings
    api_key = settings.google_api_key
```

## Adding New Commands

1. Create command in `src/clipscribe/commands/cli.py`
2. Add to async command list if needed
3. Update help text with examples
4. Add to documentation
5. Create example script in `examples/`

## Testing Commands

```python
# In tests/unit/test_cli.py
def test_command():
    runner = CliRunner()
    result = runner.invoke(cli, ['command-name', 'arg'])
    assert result.exit_code == 0
    assert "Success" in result.output
```
